<div>
  <q-card>
    <q-card-section class="q-pb-none">
      <div class="row items-center q-col-gutter-sm">
        <div class="col-auto">
          <h6 class="text-subtitle1 q-my-none">Messages</h6>
        </div>
        <div class="col-auto">
          <q-badge v-if="totalUnreadMessages" color="primary">
            <span v-text="totalUnreadMessages"></span>&nbsp;new
          </q-badge>
        </div>
        <div class="col-auto q-ml-auto">
          <q-btn
            @click="showAddPublicKey = true"
            flat
            dense
            icon="person_add"
            color="primary"
          >
            <q-tooltip>Add a contact to chat with</q-tooltip>
          </q-btn>
        </div>
      </div>
    </q-card-section>
    <q-separator></q-separator>
    <q-card-section class="q-pa-none">
      <div class="row" style="min-height: 500px">
        <!-- Contact Sidebar -->
        <div
          class="col-4 contact-sidebar"
          style="
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
            max-height: 500px;
          "
        >
          <q-list separator>
            <q-item
              v-for="customer in sortedCustomers"
              :key="customer.public_key"
              clickable
              :active="activePublicKey === customer.public_key"
              active-class="bg-grey-9"
              @click="selectCustomer(customer.public_key)"
            >
              <q-item-section avatar>
                <q-avatar size="40px">
                  <img
                    v-if="customer.profile?.picture"
                    :src="customer.profile.picture"
                    @error="handleAvatarError($event, customer)"
                  />
                  <div
                    v-else
                    class="identicon-avatar"
                    :style="getIdenticonStyle(customer.public_key)"
                  ></div>
                </q-avatar>
              </q-item-section>
              <q-item-section>
                <q-item-label class="ellipsis">
                  <span v-text="customer.profile?.name || 'Unknown'"></span>
                </q-item-label>
                <q-item-label caption class="ellipsis text-grey-6">
                  <span
                    v-text="customer.profile?.nip05 || truncateNpub(customer.public_key)"
                  ></span>
                </q-item-label>
                <q-item-label
                  v-if="customer.lastMessage"
                  caption
                  class="ellipsis text-grey-5"
                  style="font-size: 0.7rem"
                >
                  <span v-text="customer.lastMessage"></span>
                </q-item-label>
              </q-item-section>
              <q-item-section side top v-if="customer.unread_messages > 0">
                <q-badge color="primary" rounded>
                  ${ customer.unread_messages }
                </q-badge>
              </q-item-section>
            </q-item>
            <q-item v-if="!customers.length" class="text-center text-grey-6">
              <q-item-section>
                <q-item-label>No contacts yet</q-item-label>
                <q-item-label caption>Click + to add a contact</q-item-label>
              </q-item-section>
            </q-item>
          </q-list>
        </div>

        <!-- Conversation Area -->
        <div class="col-8 column">
          <div v-if="activePublicKey" class="col column">
            <!-- Chat Header -->
            <div
              class="row items-center q-pa-sm"
              style="border-bottom: 1px solid rgba(255, 255, 255, 0.1)"
            >
              <q-avatar size="32px" class="q-mr-sm">
                <img
                  v-if="activeCustomer && activeCustomer.profile.picture"
                  :src="activeCustomer.profile.picture"
                />
                <div
                  v-else
                  class="identicon-avatar"
                  :style="getIdenticonStyle(activePublicKey)"
                ></div>
              </q-avatar>
              <div class="col">
                <a
                  :href="'https://njump.me/' + toNpub(activePublicKey)"
                  target="_blank"
                  class="text-subtitle2 text-white"
                  style="text-decoration: none"
                  v-text="activeCustomer?.profile.name || 'Unknown'"
                ></a>
                <div
                  class="text-caption text-grey-6"
                  v-text="activeCustomer?.profile.nip05 || truncateNpub(activePublicKey)"
                ></div>
              </div>
              <q-btn
                flat
                dense
                icon="receipt"
                color="primary"
                @click="showClientOrders"
              >
                <q-tooltip>View orders from this customer</q-tooltip>
              </q-btn>
            </div>

            <!-- Messages Area -->
            <div
              class="col chat-messages q-pa-sm"
              style="overflow-y: auto; flex: 1"
            >
              <q-chat-message
                v-for="(dm, index) in messagesAsJson"
                :key="index"
                :name="dm.incoming ? (activeCustomer?.profile.name || 'Customer') : 'Me'"
                :sent="!dm.incoming"
                :stamp="dm.dateFrom"
                :bg-color="dm.incoming ? 'grey-9' : 'primary'"
                text-color="white"
                :class="'chat-message-index-' + index"
              >
                <template v-slot:avatar v-if="dm.incoming">
                  <q-avatar size="28px" class="q-mr-sm">
                    <img
                      v-if="activeCustomer && activeCustomer.profile.picture"
                      :src="activeCustomer.profile.picture"
                    />
                    <div
                      v-else
                      class="identicon-avatar"
                      :style="getIdenticonStyle(activePublicKey)"
                    ></div>
                  </q-avatar>
                </template>
                <div v-if="dm.isJson">
                  <div v-if="dm.message.type === 0">
                    <strong>New order:</strong>
                  </div>
                  <div v-else-if="dm.message.type === 1">
                    <strong>Reply sent for order:</strong>
                  </div>
                  <div v-else-if="dm.message.type === 2">
                    <q-badge
                      v-if="dm.message.paid"
                      color="green"
                      class="q-mr-xs"
                      >Paid</q-badge
                    >
                    <q-badge v-if="dm.message.shipped" color="green"
                      >Shipped</q-badge
                    >
                  </div>
                  <div>
                    <span v-text="dm.message.message"></span>
                    <q-badge
                      color="orange"
                      class="cursor-pointer q-ml-xs"
                      @click="showOrderDetails(dm.message.id, dm.event_id)"
                    >
                      <span v-text="dm.message.id"></span>
                    </q-badge>
                  </div>
                  <q-badge
                    @click="showMessageRawData(index)"
                    class="cursor-pointer q-mt-xs"
                    >...</q-badge
                  >
                </div>
                <div v-else><span v-text="dm.message"></span></div>
              </q-chat-message>
            </div>

            <!-- Message Input -->
            <div
              class="q-pa-sm"
              style="border-top: 1px solid rgba(255, 255, 255, 0.1)"
            >
              <q-form
                @submit="sendDirectMesage"
                class="row items-center q-col-gutter-sm"
              >
                <div class="col">
                  <q-input
                    ref="newMessage"
                    v-model="newMessage"
                    placeholder="Type a message..."
                    dense
                    outlined
                    class="full-width"
                  ></q-input>
                </div>
                <div class="col-auto">
                  <q-btn
                    round
                    dense
                    unelevated
                    type="submit"
                    icon="send"
                    color="primary"
                    :disable="!newMessage"
                  ></q-btn>
                </div>
              </q-form>
            </div>
          </div>

          <!-- No Conversation Selected -->
          <div
            v-else
            class="col column items-center justify-center text-grey-6"
          >
            <q-icon name="chat" size="64px" class="q-mb-md"></q-icon>
            <div class="text-h6">Select a conversation</div>
            <div class="text-caption">
              Choose a contact from the list to start chatting
            </div>
          </div>
        </div>
      </div>
    </q-card-section>
  </q-card>

  <!-- Add Public Key Dialog -->
  <q-dialog v-model="showAddPublicKey" position="top">
    <q-card class="q-pa-lg q-pt-xl" style="width: 500px">
      <q-form @submit="addPublicKey" class="q-gutter-md">
        <q-input
          filled
          dense
          v-model.trim="newPublicKey"
          label="Public Key (hex or npub)"
        ></q-input>
        <div class="row q-mt-lg">
          <q-btn
            unelevated
            color="primary"
            :disable="!newPublicKey"
            type="submit"
            >Add</q-btn
          >
          <q-btn v-close-popup flat color="grey" class="q-ml-auto"
            >Cancel</q-btn
          >
        </div>
      </q-form>
    </q-card>
  </q-dialog>

  <!-- Raw Message Dialog -->
  <q-dialog v-model="showRawMessage" position="top">
    <q-card class="q-pa-lg q-pt-xl" style="width: 500px">
      <q-form>
        <q-input
          filled
          dense
          type="textarea"
          rows="20"
          v-model.trim="rawMessage"
          label="Raw Data"
        ></q-input>
        <div class="row q-mt-lg">
          <q-btn v-close-popup flat color="grey" class="q-ml-auto">Close</q-btn>
        </div>
      </q-form>
    </q-card>
  </q-dialog>
</div>
