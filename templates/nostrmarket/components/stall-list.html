<div>
  <div class="row items-center q-mb-md q-col-gutter-sm justify-end">
    <div class="col-auto">
      <q-input
        dense
        debounce="300"
        v-model="filter"
        placeholder="Search by name, currency..."
        style="min-width: 250px"
      >
        <template v-slot:prepend>
          <q-icon name="search"></q-icon>
        </template>
      </q-input>
    </div>
    <div class="col-auto">
      <q-btn
        @click="openSelectPendingStallDialog"
        outline
        color="primary"
        icon="restore"
        label="Restore Stall"
        class="q-px-md"
      ></q-btn>
    </div>
    <div class="col-auto">
      <q-btn
        @click="openCreateStallDialog()"
        unelevated
        color="primary"
        icon="add"
        label="New Stall"
        class="q-px-md"
      ></q-btn>
    </div>
  </div>

  <q-table
    flat
    dense
    :rows="stalls"
    row-key="id"
    :columns="stallsTable.columns"
    v-model:pagination="stallsTable.pagination"
    :filter="filter"
  >
    <template v-slot:body="props">
      <q-tr :props="props">
        <q-td key="name" :props="props">
          <span v-text="shortLabel(props.row.name)"></span>
        </q-td>
        <q-td key="currency" :props="props">
          <span v-text="props.row.currency"></span>
        </q-td>
        <q-td key="description" :props="props">
          <span v-text="shortLabel(props.row.config.description)"></span>
        </q-td>
        <q-td key="shippingZones" :props="props">
          <span
            v-text="shortLabel(props.row.shipping_zones.filter(z => !!z.name).map(z => z.name).join(', '))"
          ></span>
        </q-td>
        <q-td key="actions" :props="props">
          <q-btn
            size="sm"
            color="primary"
            dense
            flat
            icon="edit"
            @click="openEditStallDialog(props.row)"
          >
            <q-tooltip>Edit stall</q-tooltip>
          </q-btn>
          <q-btn
            size="sm"
            color="secondary"
            dense
            flat
            icon="inventory_2"
            @click="goToProducts(props.row)"
          >
            <q-tooltip>View products</q-tooltip>
          </q-btn>
          <q-btn
            size="sm"
            color="accent"
            dense
            flat
            icon="receipt"
            @click="goToOrders(props.row)"
          >
            <q-tooltip>View orders</q-tooltip>
          </q-btn>
          <q-btn
            size="sm"
            color="negative"
            dense
            flat
            icon="delete"
            @click="confirmDeleteStall(props.row)"
          >
            <q-tooltip>Delete stall</q-tooltip>
          </q-btn>
        </q-td>
      </q-tr>
    </template>
  </q-table>

  <!-- Create Stall Dialog -->
  <q-dialog v-model="stallDialog.show" position="top">
    <q-card class="q-pa-lg q-pt-xl" style="width: 500px">
      <q-form @submit="sendStallFormData" class="q-gutter-md">
        <q-input
          filled
          dense
          v-model.trim="stallDialog.data.name"
          label="Name"
        ></q-input>
        <q-input
          filled
          dense
          v-model.trim="stallDialog.data.description"
          type="textarea"
          rows="3"
          label="Description"
        ></q-input>
        <q-select
          filled
          dense
          emit-value
          v-model="stallDialog.data.wallet"
          :options="walletOptions"
          label="Wallet *"
        >
        </q-select>
        <q-select
          filled
          dense
          v-model="stallDialog.data.currency"
          type="text"
          label="Unit"
          :options="currencies"
        ></q-select>
        <q-select
          :options="filteredZoneOptions"
          filled
          dense
          multiple
          v-model.trim="stallDialog.data.shippingZones"
          label="Shipping Zones"
        ></q-select>

        <div class="row q-mt-lg">
          <q-btn
            unelevated
            color="primary"
            :disable="!stallDialog.data.name
            || !stallDialog.data.currency
            || !stallDialog.data.wallet
            || !stallDialog.data.shippingZones
            || !stallDialog.data.shippingZones.length"
            type="submit"
            :label="stallDialog.data.id ? 'Restore Stall' : 'Create Stall'"
          ></q-btn>
          <q-btn v-close-popup flat color="grey" class="q-ml-auto"
            >Cancel</q-btn
          >
        </div>
      </q-form>
    </q-card>
  </q-dialog>

  <!-- Edit Stall Dialog -->
  <q-dialog v-model="editDialog.show" position="top">
    <q-card class="q-pa-lg q-pt-xl" style="width: 500px">
      <q-form @submit="updateStall" class="q-gutter-md">
        <q-input
          filled
          dense
          readonly
          disabled
          v-model.trim="editDialog.data.id"
          label="ID"
        ></q-input>
        <q-input
          filled
          dense
          v-model.trim="editDialog.data.name"
          label="Name"
        ></q-input>
        <q-input
          filled
          dense
          v-model.trim="editDialog.data.description"
          type="textarea"
          rows="3"
          label="Description"
        ></q-input>
        <q-select
          filled
          dense
          emit-value
          v-model="editDialog.data.wallet"
          :options="walletOptions"
          label="Wallet *"
        >
        </q-select>
        <q-select
          filled
          dense
          v-model="editDialog.data.currency"
          type="text"
          label="Unit"
          :options="currencies"
        ></q-select>
        <q-select
          :options="editFilteredZoneOptions"
          filled
          dense
          multiple
          v-model.trim="editDialog.data.shippingZones"
          label="Shipping Zones"
        ></q-select>

        <div class="row q-mt-lg">
          <q-btn
            unelevated
            color="primary"
            type="submit"
            label="Update Stall"
          ></q-btn>
          <q-btn v-close-popup flat color="grey" class="q-ml-auto"
            >Cancel</q-btn
          >
        </div>
      </q-form>
    </q-card>
  </q-dialog>

  <!-- Restore Stall Dialog -->
  <q-dialog v-model="stallDialog.showRestore" position="top">
    <q-card class="q-pa-lg q-pt-xl" style="width: 500px">
      <div v-if="pendingStalls && pendingStalls.length" class="row q-mt-lg">
        <q-item
          v-for="pendingStall of pendingStalls"
          :key="pendingStall.id"
          tag="label"
          class="full-width"
          v-ripple
        >
          <q-item-section>
            <q-item-label
              ><span v-text="pendingStall.name"></span
            ></q-item-label>
            <q-item-label caption
              ><span v-text="pendingStall.config?.description"></span
            ></q-item-label>
          </q-item-section>

          <q-item-section class="q-pl-xl float-right">
            <q-btn
              @click="openRestoreStallDialog(pendingStall)"
              v-close-popup
              flat
              color="green"
              class="q-ml-auto float-right"
              >Restore</q-btn
            >
          </q-item-section>
          <q-item-section class="float-right">
            <q-btn
              @click="deleteStall(pendingStall)"
              v-close-popup
              color="red"
              class="q-ml-auto float-right"
              icon="cancel"
            ></q-btn>
          </q-item-section>
        </q-item>
      </div>
      <div v-else>There are no stalls to be restored.</div>
      <div class="row q-mt-lg">
        <q-btn v-close-popup flat color="grey" class="q-ml-auto">Close</q-btn>
      </div>
    </q-card>
  </q-dialog>
</div>
